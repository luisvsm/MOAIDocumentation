<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />
<meta name="robots" content="noindex" />

<title>Moai Forum &bull; View topic - Rare crash in MOAIAction (with my fix)</title>

<link href="styles/proFormell/theme/print.css" rel="stylesheet" type="text/css" />
<link type="image/vnd.microsoft.icon" rel="shortcut icon" href="styles/proFormell/theme/images/favicon.ico">
</head>

<body id="phpbb">
<div id="wrap">
	<a id="top" name="top" accesskey="t"></a>

	<div id="page-header">
		<h1>Moai Forum</h1>
		<p>The mobile platform for pro game developers<br /><a href="index.html">/forums/</a></p>

		<h2>Rare crash in MOAIAction (with my fix)</h2>
		<p><a href="rare-crash-in-moaiaction-with-my-fix-t1469/index.html">/forums/rare-crash-in-moaiaction-with-my-fix-t1469/</a></p>
	</div>

	<div id="page-body">
		<div class="page-number">Page <strong>1</strong> of <strong>1</strong></div>
		
			<div class="post">
				<h3>Rare crash in MOAIAction (with my fix)</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Sat Dec 08, 2012 3:44 pm</strong></div>
				<div class="author">by <strong>ex</strong></div>
				<div class="content">Hi,<br /><br />I found one quite rare bug in MOAIAction, that crashes a whole app when GC is working.<br />This bug appears only when one action is attached to another and GC is trying to collect them. GC calls MOAILuaObject::_gc, it clears all lua-related fields (e.g. mMemberTable), then calls MOAIAction's destructor. Here (~MOAIAction -&gt; ClearChildren -&gt; Attach) OnStop is called and... boom! As you can see in the backtrace MOAILuaObject::PushRefTable uses mMemberTable, but it was already cleared in MOAILuaObject::_gc.<br /><br />Here is my test case:<br /><dl class="codebox"><dt>Code: <a href="viewtopic.php%3Ff=10&amp;t=1469&amp;start=0&amp;view=print.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code style="line-height: 30%;"><ol class="lua" style="font-family:monospace;"><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #aa9900; font-weight: bold;">local</span> parent <span style="color: #66cc66;">=</span> MOAIAction<span style="color: #66cc66;">.</span>new<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #aa9900; font-weight: bold;">local</span> child <span style="color: #66cc66;">=</span> MOAIAction<span style="color: #66cc66;">.</span>new<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">child<span style="color: #66cc66;">:</span>setListener<span style="color: #66cc66;">&#40;</span>MOAIAction<span style="color: #66cc66;">.</span>EVENT_STOP<span style="color: #66cc66;">,</span> <span style="color: #aa9900; font-weight: bold;">function</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #aa9900; font-weight: bold;">end</span><span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">child<span style="color: #66cc66;">:</span>start<span style="color: #66cc66;">&#40;</span>parent<span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">parent<span style="color: #66cc66;">:</span>start<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">parent<span style="color: #66cc66;">:</span>stop<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">child <span style="color: #66cc66;">=</span> <span style="color: #aa9900;">nil</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">parent <span style="color: #66cc66;">=</span> <span style="color: #aa9900;">nil</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">MOAISim<span style="color: #66cc66;">.</span>forceGarbageCollection<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span></div></li><br /></ol></code></dd></dl><br /><br />Backtrace:<br /><dl class="codebox"><dt>Code: <a href="viewtopic.php%3Ff=10&amp;t=1469&amp;start=0&amp;view=print.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code style="line-height: 30%;"><ol class="text" style="font-family:monospace;"><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">moai: /home/ex/projects/moai-dev/src/moaicore/MOAILuaObject.cpp:473: void MOAILuaObject::PushRefTable(MOAILuaState&amp;): Assertion `this-&gt;mMemberTable' failed.</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">Program received signal SIGABRT, Aborted.</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">0x00007ffff524dfd5 in raise () from /usr/lib/libc.so.6</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">(gdb) bt</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#0 &nbsp;0x00007ffff524dfd5 in raise () from /usr/lib/libc.so.6</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#1 &nbsp;0x00007ffff524f458 in abort () from /usr/lib/libc.so.6</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#2 &nbsp;0x00007ffff5247022 in __assert_fail_base () from /usr/lib/libc.so.6</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#3 &nbsp;0x00007ffff52470d2 in __assert_fail () from /usr/lib/libc.so.6</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#4 &nbsp;0x000000000061d339 in MOAILuaObject::PushRefTable(MOAILuaState&amp;) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#5 &nbsp;0x000000000061d244 in MOAILuaObject::PushLocal(MOAILuaState&amp;, MOAILuaLocal&amp;) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#6 &nbsp;0x00000000005f8e29 in MOAIInstanceEventSource::PushListenerTable(MOAILuaState&amp;) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#7 &nbsp;0x00000000005f84bf in MOAIEventSource::PushListener(unsigned int, MOAILuaState&amp;) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#8 &nbsp;0x00000000005f8540 in MOAIEventSource::PushListenerAndSelf(unsigned int, MOAILuaState&amp;) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#9 &nbsp;0x000000000065f3de in MOAIAction::OnStop() ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#10 0x000000000065e7a6 in MOAIAction::Attach(MOAIAction*) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#11 0x000000000065e891 in MOAIAction::ClearChildren() ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#12 0x000000000065f142 in MOAIAction::~MOAIAction() ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#13 0x000000000065f346 in MOAIAction::~MOAIAction() ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#14 0x000000000061bb2f in MOAILuaObject::_gc(lua_State*) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#15 0x000000000072b8ae in luaD_precall (L=0xda46c0, func=0xda4af0, nresults=0) at /home/ex/projects/moai-dev/3rdparty/lua-5.1.3/src/ldo.c:319</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#16 0x000000000072bb42 in luaD_call (L=0xda46c0, func=0xda4af0, nResults=0) at /home/ex/projects/moai-dev/3rdparty/lua-5.1.3/src/ldo.c:376</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#17 0x000000000072de9b in GCTM (L=0xda46c0) at /home/ex/projects/moai-dev/3rdparty/lua-5.1.3/src/lgc.c:467</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#18 0x000000000072e495 in singlestep (L=0xda46c0) at /home/ex/projects/moai-dev/3rdparty/lua-5.1.3/src/lgc.c:594</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#19 0x000000000072e6e0 in luaC_fullgc (L=0xda46c0) at /home/ex/projects/moai-dev/3rdparty/lua-5.1.3/src/lgc.c:656</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#20 0x0000000000722e08 in lua_gc (L=0xda46c0, what=2, data=0) at /home/ex/projects/moai-dev/3rdparty/lua-5.1.3/src/lapi.c:915</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#21 0x00000000005b95fe in MOAILuaRuntime::ForceGarbageCollection() ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#22 0x0000000000670852 in MOAISim::_forceGarbageCollection(lua_State*) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#23 0x000000000072b8ae in luaD_precall (L=0xda46c0, func=0xda4ae0, nresults=0) at /home/ex/projects/moai-dev/3rdparty/lua-5.1.3/src/ldo.c:319</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#24 0x0000000000727c94 in luaV_execute (L=0xda46c0, nexeccalls=1) at /home/ex/projects/moai-dev/3rdparty/lua-5.1.3/src/lvm.c:587</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#25 0x000000000072bb57 in luaD_call (L=0xda46c0, func=0xda4aa0, nResults=0) at /home/ex/projects/moai-dev/3rdparty/lua-5.1.3/src/ldo.c:377</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#26 0x0000000000722a92 in f_call (L=0xda46c0, ud=0x7fffffffe3c0) at /home/ex/projects/moai-dev/3rdparty/lua-5.1.3/src/lapi.c:801</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#27 0x000000000072ab03 in luaD_rawrunprotected (L=0xda46c0, f=0x722a5d &lt;f_call&gt;, ud=0x7fffffffe3c0) at /home/ex/projects/moai-dev/3rdparty/lua-5.1.3/src/ldo.c:116</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#28 0x000000000072bf56 in luaD_pcall (L=0xda46c0, func=0x722a5d &lt;f_call&gt;, u=0x7fffffffe3c0, old_top=32, ef=16) at /home/ex/projects/moai-dev/3rdparty/lua-5.1.3/src/ldo.c:463</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#29 0x0000000000722b3a in lua_pcall (L=0xda46c0, nargs=0, nresults=0, errfunc=1) at /home/ex/projects/moai-dev/3rdparty/lua-5.1.3/src/lapi.c:822</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#30 0x00000000005c3082 in MOAILuaState::DebugCall(int, int) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#31 0x00000000005a73fc in AKURunScript(char const*) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#32 0x00000000005a66d4 in GlutHost(int, char**) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#33 0x00000000005a617c in main ()</div></li><br /></ol></code></dd></dl><br /><br />The same issue with all MOAIAction's descendants' events (e.g. MOAITimer.EVENT_TIMER_KEYFRAME).<br /><br />My fix: <!-- m --><a class="postlink" href="https://github.com/ex-rzr/moai-dev/commit/a2254df0749d5eb675c80061509e134fa8b4c728">https://github.com/ex-rzr/moai-dev/comm ... 4fa8b4c728</a><!-- m --></div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: Rare crash in MOAIAction (with my fix)</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Sat Dec 08, 2012 4:06 pm</strong></div>
				<div class="author">by <strong>ex</strong></div>
				<div class="content">Looks like ignisdeveloper found the same bug: <!-- l --><a class="postlink-local" href="rapanui-a-new-open-source-high-level-programming-framework-for-moai-t307/page120.html#p5937">rapanui-a-new-open-source-high-level-programming-framework-for-moai-t307/page120.html#p5937</a><!-- l --><br /><blockquote><div><cite>ignisdeveloper wrote:</cite>Assertion failed: (this-&gt;mMemberTable), function PushRefTable, file /Users/truman/Documents/moai-dev/xcode/libmoai/../../src/moaicore/MOAILuaObject.cpp, line 473.<br />Abort trap: 6<br /></div></blockquote></div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: Rare crash in MOAIAction (with my fix)</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Sun Dec 09, 2012 6:32 pm</strong></div>
				<div class="author">by <strong>ex</strong></div>
				<div class="content">Ok, I think that we have two bugs.<br />Another thread about them: <!-- l --><a class="postlink-local" href="moai-crash-t942/index.html">moai-crash-t942/</a><!-- l --><br /><br />I looked at RapaNui sources and wrote a small test case that gives the same stacktrace as in ignisdeveloper's report.<br /><br /><dl class="codebox"><dt>Code: <a href="viewtopic.php%3Ff=10&amp;t=1469&amp;start=0&amp;view=print.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code style="line-height: 30%;"><ol class="lua" style="font-family:monospace;"><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">MOAISim<span style="color: #66cc66;">.</span>openWindow<span style="color: #66cc66;">&#40;</span><span style="color: #ff6666;">'test'</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">100</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">100</span><span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #aa9900; font-weight: bold;">local</span> iterations <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">5</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #aa9900; font-weight: bold;">local</span> timer <span style="color: #66cc66;">=</span> MOAITimer<span style="color: #66cc66;">.</span>new<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">timer<span style="color: #66cc66;">:</span>setMode<span style="color: #66cc66;">&#40;</span>MOAITimer<span style="color: #66cc66;">.</span>LOOP<span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #aa9900; font-weight: bold;">local</span> curve <span style="color: #66cc66;">=</span> MOAIAnimCurve<span style="color: #66cc66;">.</span>new<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">curve<span style="color: #66cc66;">:</span>reserveKeys<span style="color: #66cc66;">&#40;</span>iterations<span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #aa9900; font-weight: bold;">for</span> i <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">1</span><span style="color: #66cc66;">,</span> iterations <span style="color: #aa9900; font-weight: bold;">do</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; curve<span style="color: #66cc66;">:</span>setKey<span style="color: #66cc66;">&#40;</span>i<span style="color: #66cc66;">,</span> i<span style="color: #66cc66;">,</span> i<span style="color: #66cc66;">,</span> MOAIEaseType<span style="color: #66cc66;">.</span>LINEAR<span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #aa9900; font-weight: bold;">end</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">timer<span style="color: #66cc66;">:</span>setCurve<span style="color: #66cc66;">&#40;</span>curve<span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">timer<span style="color: #66cc66;">:</span>setListener<span style="color: #66cc66;">&#40;</span>MOAITimer<span style="color: #66cc66;">.</span>EVENT_TIMER_KEYFRAME<span style="color: #66cc66;">,</span> <span style="color: #aa9900; font-weight: bold;">function</span><span style="color: #66cc66;">&#40;</span>self<span style="color: #66cc66;">,</span> keyframe<span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; <span style="color: #0000aa;">print</span><span style="color: #66cc66;">&#40;</span><span style="color: #ff6666;">'EVENT_TIMER_KEYFRAME'</span><span style="color: #66cc66;">,</span> keyframe<span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; <span style="color: #aa9900; font-weight: bold;">if</span> keyframe <span style="color: #66cc66;">==</span> iterations <span style="color: #aa9900; font-weight: bold;">then</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000aa;">print</span><span style="color: #66cc66;">&#40;</span><span style="color: #ff6666;">'stop'</span><span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; self<span style="color: #66cc66;">:</span>stop<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; self <span style="color: #66cc66;">=</span> <span style="color: #aa9900;">nil</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; MOAISim<span style="color: #66cc66;">.</span>forceGarbageCollection<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; <span style="color: #aa9900; font-weight: bold;">end</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #aa9900; font-weight: bold;">end</span><span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">timer<span style="color: #66cc66;">:</span>setSpan<span style="color: #66cc66;">&#40;</span>iterations<span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">timer<span style="color: #66cc66;">:</span>setSpeed<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">timer<span style="color: #66cc66;">:</span>start<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span></div></li><br /></ol></code></dd></dl><br />This code is based on <!-- m --><a class="postlink" href="https://github.com/ymobe/rapanui/blob/master/rapanui-sdk/RNTimer.lua#L53">https://github.com/ymobe/rapanui/blob/m ... er.lua#L53</a><!-- m --><br /><br />Trace:<br /><dl class="codebox"><dt>Code: <a href="viewtopic.php%3Ff=10&amp;t=1469&amp;start=0&amp;view=print.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code style="line-height: 30%;"><ol class="text" style="font-family:monospace;"><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">EVENT_TIMER_KEYFRAME&nbsp; &nbsp; 1</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">EVENT_TIMER_KEYFRAME&nbsp; &nbsp; 2</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">EVENT_TIMER_KEYFRAME&nbsp; &nbsp; 3</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">EVENT_TIMER_KEYFRAME&nbsp; &nbsp; 4</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">EVENT_TIMER_KEYFRAME&nbsp; &nbsp; 5</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">stop</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">moai: /home/ex/projects/moai-dev/src/moaicore/MOAILuaObject.cpp:473: void MOAILuaObject::PushRefTable(MOAILuaState&amp;): Assertion `this-&gt;mMemberTable' failed.</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">Program received signal SIGABRT, Aborted.</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">0x00007ffff524dfd5 in raise () from /usr/lib/libc.so.6</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">(gdb) bt</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#0 &nbsp;0x00007ffff524dfd5 in raise () from /usr/lib/libc.so.6</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#1 &nbsp;0x00007ffff524f458 in abort () from /usr/lib/libc.so.6</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#2 &nbsp;0x00007ffff5247022 in __assert_fail_base () from /usr/lib/libc.so.6</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#3 &nbsp;0x00007ffff52470d2 in __assert_fail () from /usr/lib/libc.so.6</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#4 &nbsp;0x000000000061d339 in MOAILuaObject::PushRefTable(MOAILuaState&amp;) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#5 &nbsp;0x000000000061d244 in MOAILuaObject::PushLocal(MOAILuaState&amp;, MOAILuaLocal&amp;) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#6 &nbsp;0x00000000005f8e29 in MOAIInstanceEventSource::PushListenerTable(MOAILuaState&amp;) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#7 &nbsp;0x00000000005f84bf in MOAIEventSource::PushListener(unsigned int, MOAILuaState&amp;) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#8 &nbsp;0x00000000005f8540 in MOAIEventSource::PushListenerAndSelf(unsigned int, MOAILuaState&amp;) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#9 &nbsp;0x000000000063c501 in MOAITimer::OnEndSpan() ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#10 0x000000000063aed4 in MOAITimer::DoStep(float) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#11 0x000000000063c7d4 in MOAITimer::OnUpdate(float) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#12 0x000000000065f6dc in MOAIAction::Update(float, unsigned int, bool) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#13 0x000000000065f8ca in MOAIAction::Update(float, unsigned int, bool) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#14 0x00000000006bf77a in MOAIActionMgr::Update(float) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#15 0x00000000006727ca in MOAISim::StepSim(double, unsigned int) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#16 0x0000000000672bb2 in MOAISim::Update() ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#17 0x00000000005a7963 in AKUUpdate() ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#18 0x00000000005a6470 in _onTimer(int) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#19 0x00007ffff778ed64 in glutMainLoopEvent () from /usr/lib/libglut.so.3</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#20 0x00007ffff778f661 in glutMainLoop () from /usr/lib/libglut.so.3</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#21 0x00000000005a671a in GlutHost(int, char**) ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">#22 0x00000000005a617c in main ()</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /></ol></code></dd></dl><br /><br />I think (but not sure) RapaNui accidentally creates conditions like in my test case: timer:stop() in MOAITimer.EVENT_TIMER_KEYFRAME callback, no more references to the timer and GC (e.g. self.step in RNListView:createTimer stops timer and removes all references to the timer). There are few MOAISim.forceGarbageCollection calls in RapaNui (Lua may also call GC automatically).<br />All these conditions make that the timer may be already 'dead' before this-&gt;OnEndSpan (<!-- m --><a class="postlink" href="https://github.com/moai/moai-dev/blob/master/src/moaicore/MOAITimer.cpp#L263">https://github.com/moai/moai-dev/blob/m ... r.cpp#L263</a><!-- m -->).<br /><br />In my opinion LuaRetain and LuaRelease or something else in MOAITimer::DoStep or MOAIAction::Update may fix this issue. Of course LuaRetain not with mParent, because it is already here (but there is also LuaRelease in MOAIAction::Stop).<br /><br />Anyway, MOAITimer/MOAIAnim callbacks with stop() and GC (especially forced) are not good <img src="images/smilies/icon_e_smile.gif" alt=":)" title="Smile" /><br /><br />Does anyone have ideas how to fix this bug in the right way?</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: Rare crash in MOAIAction (with my fix)</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Mon Dec 02, 2013 10:57 am</strong></div>
				<div class="author">by <strong>nosheet</strong></div>
				<div class="content">Strangely enough, I found the same bug when building the Moai from the current Moai-Dev repository. I'm not using RapaNui, by the way. So far I've worked with a version of moai from May 2013 and it didn't appear.<br />The difference is that I get assertion failed as the assert has been added to the MOAILuaObject in the meantime.<br /><dl class="codebox"><dt>Code: <a href="viewtopic.php%3Ff=10&amp;t=1469&amp;start=0&amp;view=print.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code style="line-height: 30%;"><ol class="" style="font-family:monospace;"><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">Assertion failed: <span class="br0">&#40;</span>this-&gt;mMemberTable<span class="br0">&#41;</span>, function PushRefTable, file /Users/neko/Documents/<span style="">4</span>_LIB/Moai/<span style="">1</span>-<span style="">40</span>_SRC_Dec1/src/moai-core/MOAILuaObject.cpp, line <span style="">493</span>.</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /></ol></code></dd></dl><br /><br />I used to call MOAISim.forceGarbageCollection() on scene change (lots of deleting going on, etc...) and I would get this assertion failed in the MOAILuaObject. If I move the force garbage collection call to a frame after I finish the scene deleting etc, using a Timer, it seems to work ok.<br /><br /><span style="font-weight: bold">EDIT:</span> Ok, makes sense that it works when i postpone the garbage collection, because the error was happening when I did the gc inside of the MOAIAction callback, which is consistent with the experiences people had above.</div>
			</div>
			<hr />
		
	</div>

	<div id="page-footer">
		<div class="page-number">All times are UTC <br />Page <strong>1</strong> of <strong>1</strong></div>
		<div class="copyright">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</div>
	</div>
</div>

</body>
</html>