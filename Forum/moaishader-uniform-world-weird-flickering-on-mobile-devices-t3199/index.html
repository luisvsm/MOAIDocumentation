<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />

<title>Moai Forum &bull; View topic - MOAIShader.UNIFORM_WORLD weird flickering on mobile devices</title>

<link rel="alternate" type="application/atom+xml" title="Feed - Moai Forum" href="../feed.php.html" /><link rel="alternate" type="application/atom+xml" title="Feed - All forums" href="../feed.php%3Fmode=forums.html" /><link rel="alternate" type="application/atom+xml" title="Feed - New Topics" href="../feed.php%3Fmode=topics.html" /><link rel="alternate" type="application/atom+xml" title="Feed - Active Topics" href="../feed.php%3Fmode=topics_active.html" /><link rel="alternate" type="application/atom+xml" title="Feed - Forum - Moai SDK" href="../feed.php%3Ff=7.html" /><link rel="alternate" type="application/atom+xml" title="Feed - Topic - MOAIShader.UNIFORM_WORLD weird flickering on mobile devices" href="http://192.168.20.226:3000/forums/feed.php?f=7&amp;t=3199" />

<!--
	phpBB style name: proFormell
	Based on style:   prosilver (this is the default phpBB3 style)
	Inspired by:	  Formell (Joomla Style)
	Original author:  Tom Beddard ( http://www.subBlue.com/ )
	Modified by:  	  Marc Alexander
	
	NOTE: This page was generated by phpBB, the free open-source bulletin board package.
	      The phpBB Group is not responsible for the content of this page and forum. For more information
	      about phpBB please visit http://www.phpbb.com
-->

<script type="text/javascript">
// <![CDATA[
	var jump_page = 'Enter the page number you wish to go to:';
	var on_page = '1';
	var per_page = '';
	var base_url = '';
	var style_cookie = 'phpBBstyle';
	var style_cookie_settings = '; path=/';
	var onload_functions = new Array();
	var onunload_functions = new Array();
	var is_ie6 = false;

	/**
	* Find a member
	*/
	function find_username(url)
	{
		popup(url, 760, 570, '_usersearch');
		return false;
	}

	/**
	* New function for handling multiple calls to window.onload and window.unload by pentapenguin
	*/
	window.onload = function()
	{
		for (var i = 0; i < onload_functions.length; i++)
		{
			eval(onload_functions[i]);
		}
	}

	window.onunload = function()
	{
		for (var i = 0; i < onunload_functions.length; i++)
		{
			eval(onunload_functions[i]);
		}
	}

// ]]>
</script>
<!--[if lt IE 7]>
<script type="text/javascript">
// <![CDATA[
var is_ie6 = true;
// ]]>
</script>
<![endif]-->


<link href="../styles/proFormell/theme/print.css" rel="stylesheet" type="text/css" media="print" title="printonly" />

<link href="../style.css" rel="stylesheet" type="text/css" media="screen, projection" />



<link href="../styles/proFormell/theme/images/favicon.ico" rel="shortcut icon" />

<script type="text/javascript" src="../styles/prosilver/template/forum_fn.js"></script>
<script src="../styles/prosilver/template/jquery-1.4.4.min.js" type="text/javascript"></script>

<script type="text/javascript">
// <![CDATA[
/**
* New pop-up functions
* based on  http://yensdesign.com/2008/09/how-to-create-a-stunning-and-smooth-popup-using-jquery/
*/

//SETTING UP OUR POPUP
//0 means disabled; 1 means enabled;
var popupStatus = 0;
var openPopup = '';

//loading popup with jQuery magic!
function loadPopup()
{
	//loads popup only if it is disabled
	if(popupStatus==0)
	{
		$('#backgroundPopup').css({'opacity': '0.7'});
		// Now let's make sure we actually see the image
		var scroll = $(window).scrollTop();
		$('#popupPM').animate({marginTop: scroll}, 'fast', function() {
			// Animation complete.
			});
		$('#backgroundPopup').fadeIn('slow');
		$('#popupPM').fadeIn('slow');
		popupStatus = 1;
		openPopup = 'PM';
	}
}

//disabling popup with jQuery magic!
function disablePopup()
{
	//disables popup only if it is enabled
	if(popupStatus==1 && openPopup == 'PM')
	{
		$('#backgroundPopup').fadeOut('slow');
		$('#popupPM').fadeOut('slow');
		popupStatus = 0;
		openPopup = '';
	}
}

//centering popup
function centerPopup()
{
	//request data for centering
	var windowWidth = document.documentElement.clientWidth;
	var windowHeight = document.documentElement.clientHeight;
	var popupHeight = $('#popupPM').height();
	var popupWidth = $('#popupPM').width();
	//centering
	$('#popupPM').css({
	'position': 'absolute',
	'top': windowHeight/2-popupHeight/2,
	'left': windowWidth/2-popupWidth/2
	});
	//only need force for IE6
	$('#backgroundPopup').css({'height': windowHeight});
}

$(document).ready(function(){
	
	resize_images();
	
	
	// IE6 and below PNG fix (not really)
	if(is_ie6)
	{
		replace_png();
	}
	
	//CLOSING POPUP
	//Click the x event!
	$('#popupPMClose').click(function(){
		disablePopup();
	});
	//Click out event!
	$('#backgroundPopup').click(function(){
		disablePopup();
		disableImage();
	});
	//Press Escape event!
	$(document).keypress(function(e){
		if(e.keyCode==27 && popupStatus==1)
		{
			disablePopup();
			disableImage();
		}
	});
	
	
	// Image popup
	$('img', 'dt.attach-image').click(function(){
		image_load($(this).attr('src'), $(this).attr('alt'));
		centerImage();
	});
	
	$('.content img').click(function(){
		var check = $(this).parent().hasClass('content');
		if(check)
		{
			image_load($(this).attr('src'), $(this).attr('alt'));
			centerImage();
		}
	});
	
	// Closing Image popup
	//Click the x event!
	$('#popupImageClose').click(function(){
		disableImage();
	});
	
	//Click image box event
	$('#popupImage').click(function(){
		disableImage();
	});
	
	//Click image event
	$('#ImagePopup img').click(function(){
		disableImage();
	});
	

});

/**
* Replaces weird looking PNG files with the respectie GIF file
* Only run this if the browser is IE6 or below
*/
function replace_png()
{
	// Fix Logo
	var str = $('#logo img').attr('src'); 
	$('#logo img').attr('src', str.substring(0, str.length - 3) + 'gif');
	
	// Fix forum icons
	$('dl.icon').each(function() {
		var str = $(this).css('background-image');
		if(str != '')
		{
			$(this).css('background-image', str.substring(0, str.length - 5) + 'gif")');
		}
	});
}


/**
* Image resizer
*/
function resize_images()
{
	var hello = $('dl.attachbox dd dl.file dt.attach-image img').innerWidth();
	var maxWidth = $('div.content').innerWidth() - 30;
	
	// resize the attached images
	$('img', 'dt.attach-image').each(function(i){
		// check the width of the image
		if ($(this).width() > maxWidth)
		{
			// calculate new image dimensions
			newWidth = maxWidth;
			newHeight = $(this).height() / ( $(this).width() / maxWidth );
			   
			// set new image dimensions
			$(this).height(newHeight).width(newWidth);
		}
	});
	
	// resize the images that were added via [img] bbcode
	$('img', 'div.content').each(function(i){
		// check the width of the image
		$(this).css('max-width', maxWidth); // fix for IE
		if ($(this).width() > maxWidth)
		{
			// calculate new image dimensions
			newWidth = maxWidth;
			newHeight = $(this).height() / ( $(this).width() / maxWidth );
			   
			// set new image dimensions
			$(this).height(newHeight).width(newWidth);
		}
	});
}

/**
* Image pop-up
*/
function image_load(src, alt)
{
	//loads popup only if it is disabled
	if(popupStatus==0)
	{
		$('#ImagePopup').html('<img id="imgpopup" src="http://192.168.20.226:3000/forums/moaishader-uniform-world-weird-flickering-on-mobile-devices-t3199/'&#32;+&#32;src&#32;+&#32;'" alt="' + alt + '" />');
		var windowWidth = document.documentElement.clientWidth;
		var windowHeight = document.documentElement.clientHeight;
		var maxWidth = windowWidth * 0.85;
		var maxHeight = windowHeight * 0.85;
		$('#popupImage img').css('max-width', maxWidth);
		$('#popupImage img').css('max-height', maxHeight);
		$('#backgroundPopup').css({'opacity': '0.7'});
		// Now let's make sure we actually see the image
		var scroll = $(window).scrollTop();
		$('#popupImage').animate({marginTop: scroll}, 'fast', function() {
			// Animation complete.
			});
		$('#backgroundPopup').fadeIn('slow');
		$('#popupImage').fadeIn('slow');
		popupStatus = 1;
		openPopup = 'Image';
	}
}

//centering popup
function centerImage()
{
	//request data for centering
	var windowWidth = document.documentElement.clientWidth;
	var windowHeight = document.documentElement.clientHeight;
	var popupHeight = $('#popupImage').height();
	var popupWidth = $('#popupImage').width();
	var newTop = windowHeight/2-popupHeight/2;
	var newLeft = windowWidth/2-popupWidth/2;
	//centering
	$('#popupImage').css({
	'position': 'absolute',
	'top': newTop,
	'left': newLeft
	});
	
	//only need force for IE6
	$('#backgroundPopup').css({'height': windowHeight});
}

//disabling popup with jQuery magic!
function disableImage()
{
	//disables popup only if it is enabled
	if(popupStatus==1 && openPopup == 'Image')
	{
		$('#backgroundPopup').fadeOut('slow');
		$('#popupImage').fadeOut('slow');
		popupStatus = 0;
		openPopup = '';
	}
}


// ]]>
</script>

</head>

<body id="phpbb" class="section-viewtopic ltr">
<!--- box border START -->
<div id="box">

<div class="top-left"></div><div class="top-center"></div><div class="top-right"></div>
<div id="left-border">
<div id="right-border">


<!--- box border END -->
<div class="inside">
 <div class="notopgap">
<div id="wrap">
	<a id="top" name="top" accesskey="t"></a>
	<div id="page-header">
		<div class="headerbar">
			<div class="inner"><!-- <span class="corners-top"><span></span></span> -->
			<div style="height: 140px ;">
			<div id="site-description">
				<div class="header-pad"><a href="index.html" title="" id="logo"><img src="../styles/proFormell/imageset/site-logo.png" width="410" height="98" alt="" title="" /></a></div>
			
		<!--		<p class="site-desc">The mobile platform for pro game developers</p> -->
				<p class="skiplink"><a href="index.html#start_here">Skip to content</a></p>
			</div>

		
    </div>

			<span class="corners-bottom"><span></span></span></div>
		</div>

		<div class="navbar">
			<div class="inner"><span class="corners-top"><span></span></span>

			<ul class="linklist navlinks">
				<li class="icon-home"><a href="../index.html" accesskey="h">Board index</a>  <strong>&#8249;</strong> <a href="../moai-development-forums.html">Moai Development Forums</a> <strong>&#8249;</strong> <a href="../moai-sdk-developer-support.html">Moai SDK</a></li>

				<li class="rightside"><a href="index.html#" onclick="fontsizeup(); return false;" onkeypress="return fontsizeup(event);" class="fontsize" title="Change font size">Change font size</a></li>

				<li class="rightside"><a href="http://192.168.20.226:3000/forums/memberlist.php?mode=email&amp;t=3199" title="E-mail friend" class="sendemail">E-mail friend</a></li><li class="rightside"><a href="http://192.168.20.226:3000/forums/viewtopic.php?f=7&amp;t=3199&amp;start=0&amp;view=print" title="Print view" accesskey="p" class="print">Print view</a></li>
			</ul>

			

			<ul class="linklist rightside">
				<li class="icon-faq"><a href="../faq.php.html" title="Frequently Asked Questions">FAQ</a></li>
				
				
			</ul>

			<span class="corners-bottom"><span></span></span></div>
		</div>
	</div>

	<a name="start_here"></a>
	<div id="page-body">
		
<h2><a href="index.html">MOAIShader.UNIFORM_WORLD weird flickering on mobile devices</a></h2>
<!-- NOTE: remove the style="display: none" when you want to have the forum description on the topic body --><div style="display: none !important;">Discussion about using Moai SDK - post questions, issues, and ideas here.<br /></div>
	<p>
		
			<strong>Moderators:</strong> naturally, seebs
		

	</p>


<div class="topic-actions">

	<div class="buttons">
	
	</div>

	
		<div class="pagination">
			12 posts
			 &bull; Page <strong>1</strong> of <strong>1</strong>
		</div>
	

</div>
<div class="clear"></div>


	<div id="p17522" class="post bg2">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			

			<h3 class="first"><a href="index.html#p17522">MOAIShader.UNIFORM_WORLD weird flickering on mobile devices</a></h3>
			<p class="author"><img src="../styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>sshukul</strong> &raquo; Wed Aug 12, 2015 11:30 am </p>

			

			<div class="content">I'm using a point lighting shader with normal maps in my game, which nosheet was very helpful in tweaking and getting to work. It looks fantastic on desktops <br /><br /><img src="http://i.imgur.com/E7wg4z8.jpg" alt="Image" /><br /><br />The problem is that it flickers wildly on mobiles, as if there is some sort of z-fighting going on for some prop pieces of the character (as shown in the video here <!-- m --><a class="postlink" href="https://www.youtube.com/watch?v=Rh5qUItpQps">https://www.youtube.com/watch?v=Rh5qUItpQps</a><!-- m -->). <br /><br />By prop pieces I mean the main character is animated using the Spriter plugin for Moai (<!-- l --><a class="postlink-local" href="../moai-support-for-spriter-animations-t1373/index.html">moai-support-for-spriter-animations-t1373/</a><!-- l -->), and the shader is applied to each of the individual pieces. However all of the main character pieces have separate priorities so it shouldn't be general z-fighting. It also only happens when this particular shader is applied, code below.<br /><br /><dl class="codebox"><dt>Code: <a href="index.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code style="line-height: 30%;"><ol class="lua" style="font-family:monospace;"><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #aa9900; font-weight: bold;">function</span> point_lighting_shader2<span style="color: #66cc66;">&#40;</span>lightx<span style="color: #66cc66;">,</span> lighty<span style="color: #66cc66;">,</span> lightz<span style="color: #66cc66;">,</span> intensity<span style="color: #66cc66;">,</span> range<span style="color: #66cc66;">,</span> red<span style="color: #66cc66;">,</span> green<span style="color: #66cc66;">,</span> blue<span style="color: #66cc66;">,</span> am_red<span style="color: #66cc66;">,</span> am_green<span style="color: #66cc66;">,</span> am_blue<span style="color: #66cc66;">&#41;</span> &nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; <span style="color: #aa9900; font-weight: bold;">local</span> fsh <span style="color: #66cc66;">=</span> <span style="color: #66cc66;">&#91;</span><span style="color: #66cc66;">&#91;</span> &nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; varying LOWP vec2 uvVarying<span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; varying LOWP vec4 positionVarying<span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; varying LOWP vec4 colourVarying<span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; </div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; varying LOWP vec4 light<span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; varying LOWP vec3 lightColour<span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; uniform sampler2D diffuseMap<span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; uniform sampler2D normalMap<span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; uniform float light_intensity<span style="color: #66cc66;">,</span> light_range<span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; </div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; uniform LOWP float ambientColourR<span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; uniform LOWP float ambientColourG<span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; uniform LOWP float ambientColourB<span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; </div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; vec2 resolution <span style="color: #66cc66;">=</span> vec2<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1.0</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">1.0</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; vec3 attenuation <span style="color: #66cc66;">=</span> vec3<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1.0</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">1.0</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">1.0</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; void main<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; <span style="color: #66cc66;">&#123;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #66cc66;">//</span>sample color &amp; normals from our textures</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; vec4 color <span style="color: #66cc66;">=</span> texture2D<span style="color: #66cc66;">&#40;</span>diffuseMap<span style="color: #66cc66;">,</span> uvVarying<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; vec3 nColor <span style="color: #66cc66;">=</span> texture2D<span style="color: #66cc66;">&#40;</span>normalMap<span style="color: #66cc66;">,</span> uvVarying<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">.</span>rgb<span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #66cc66;">//</span>normals need to be converted to <span style="color: #66cc66;">&#91;</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">1.0</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">1.0</span><span style="color: #66cc66;">&#93;</span> range <span style="color: #aa9900; font-weight: bold;">and</span> normalized</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; vec3 normal <span style="color: #66cc66;">=</span> normalize<span style="color: #66cc66;">&#40;</span>nColor <span style="color: #66cc66;">*</span> <span style="color: #cc66cc;">2.0</span> <span style="color: #66cc66;">-</span> <span style="color: #cc66cc;">1.0</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #66cc66;">//</span>here we <span style="color: #aa9900; font-weight: bold;">do</span> a simple distance calculation</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; vec3 deltaPos <span style="color: #66cc66;">=</span> vec3<span style="color: #66cc66;">&#40;</span>light<span style="color: #66cc66;">.</span>xy <span style="color: #66cc66;">-</span> positionVarying<span style="color: #66cc66;">.</span>xy<span style="color: #66cc66;">,</span> light<span style="color: #66cc66;">.</span>z <span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; </div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; float vertex_dist <span style="color: #66cc66;">=</span> length <span style="color: #66cc66;">&#40;</span>deltaPos<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; </div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #66cc66;">//</span>gl_FragColor <span style="color: #66cc66;">=</span> vec4<span style="color: #66cc66;">&#40;</span>deltaPos<span style="color: #66cc66;">,</span> light<span style="color: #66cc66;">.</span>a<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #66cc66;">//</span> Decay light factor depending on the vertex distance from light source</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; float decay <span style="color: #66cc66;">=</span> <span style="color: #0000aa;">max</span><span style="color: #66cc66;">&#40;</span> <span style="color: #cc66cc;">0.0</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span>light_range <span style="color: #66cc66;">-</span> vertex_dist <span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">/</span> light_range <span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">*</span> <span style="color: #cc66cc;">2.0</span><span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; vec3 lightDir <span style="color: #66cc66;">=</span> normalize<span style="color: #66cc66;">&#40;</span>deltaPos<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; float lambert <span style="color: #66cc66;">=</span> clamp<span style="color: #66cc66;">&#40;</span>dot<span style="color: #66cc66;">&#40;</span>normal<span style="color: #66cc66;">,</span> lightDir<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">0.0</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">1.0</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #66cc66;">//</span>now let<span style="color: #ff6666;">'s get a nice little falloff</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp; &nbsp; &nbsp;float d = sqrt(dot(deltaPos, deltaPos)); &nbsp; &nbsp; &nbsp;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp; &nbsp; &nbsp;float att = ( attenuation.x + (attenuation.y*d) + (attenuation.z*d*d) );</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp; &nbsp; &nbsp;vec3 ambientColor = vec3(ambientColourR, ambientColourG, ambientColourB);</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp; &nbsp; &nbsp;vec3 result = ambientColor + (lightColour.rgb * lambert * light_intensity * decay) * att;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp; &nbsp; &nbsp;result *= color.rgb;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp; &nbsp; &nbsp;gl_FragColor = vec4(result, color.a);</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;}</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;]]</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;local vsh = [[ </span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;attribute vec4 position;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;attribute vec2 uv;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;uniform LOWP float lightX;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;uniform LOWP float lightY;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;uniform LOWP float lightZ;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;uniform LOWP float lightColourR;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;uniform LOWP float lightColourG;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;uniform LOWP float lightColourB;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;uniform LOWP float moveWithProp;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;uniform mat4 worldMatrix; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Sum of all MOAITransforms on object</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;varying vec2 uvVarying;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;varying vec4 positionVarying; &nbsp; </span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;varying vec4 light;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;varying vec3 lightColour;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;void main () {</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp; &nbsp;uvVarying = uv;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp; &nbsp;positionVarying = position * worldMatrix;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp; &nbsp;light = vec4(lightX, lightY, lightZ, 1.0) * worldMatrix;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp; &nbsp;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp; &nbsp;lightColour = vec3(lightColourR, lightColourG, lightColourB);</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp; &nbsp;//if(worldMatrix[0].w &gt; 0.0)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp; &nbsp; &nbsp;//colourVarying = vec4(5.0,5.0,5.0,1.0);</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp; &nbsp;gl_Position = position;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;}</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;]]</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;local shader = MOAIShader.new ()</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:reserveUniforms ( 15 )</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:declareUniformSampler( 1, '</span>diffuseMap<span style="color: #ff6666;">', 1 )</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:declareUniformSampler( 2, '</span>normalMap<span style="color: #ff6666;">', 2 )</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:declareUniform( 3, '</span>lightX<span style="color: #ff6666;">', MOAIShader.UNIFORM_FLOAT )</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:declareUniform( 4, '</span>lightY<span style="color: #ff6666;">', MOAIShader.UNIFORM_FLOAT )</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:declareUniform( 5, '</span>lightZ<span style="color: #ff6666;">', MOAIShader.UNIFORM_FLOAT)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; </span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:declareUniform( 6, '</span>lightColourR<span style="color: #ff6666;">', MOAIShader.UNIFORM_FLOAT)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:declareUniform( 7, '</span>lightColourG<span style="color: #ff6666;">', MOAIShader.UNIFORM_FLOAT )</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:declareUniform( 8, '</span>lightColourB<span style="color: #ff6666;">', MOAIShader.UNIFORM_FLOAT )</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:declareUniform( 9, '</span>light_intensity<span style="color: #ff6666;">', MOAIShader.UNIFORM_FLOAT )</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:declareUniform( 10, '</span>light_range<span style="color: #ff6666;">', MOAIShader.UNIFORM_FLOAT )</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:declareUniform( 11, '</span>ambientColourR<span style="color: #ff6666;">', MOAIShader.UNIFORM_FLOAT)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:declareUniform( 12, '</span>ambientColourG<span style="color: #ff6666;">', MOAIShader.UNIFORM_FLOAT )</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:declareUniform( 13, '</span>ambientColourB<span style="color: #ff6666;">', MOAIShader.UNIFORM_FLOAT )</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:declareUniform( 14, '</span>moveWithProp<span style="color: #ff6666;">', MOAIShader.UNIFORM_FLOAT)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:declareUniform( 15, '</span>worldMatrix<span style="color: #ff6666;">', MOAIShader.UNIFORM_WORLD )</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;-- Light position</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:setAttr(3, lightx)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:setAttr(4, lighty)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:setAttr(5, lightz)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;-- Light colour</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:setAttr(6, red)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:setAttr(7, green)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:setAttr(8, blue)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:setAttr(9, intensity * .4)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:setAttr(10, range)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:setAttr(11, am_red)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:setAttr(12, am_green)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:setAttr(13, am_blue)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;if move_with_prop then</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;shader:setAttr(14, 1.0)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;else </span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp; &nbsp;shader:setAttr(14, 0.0)</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;end</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:setVertexAttribute ( 1, '</span>position<span style="color: #ff6666;">' )</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:setVertexAttribute ( 2, '</span>uv<span style="color: #ff6666;">' )</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:setVertexAttribute ( 3, '</span>colour<span style="color: #ff6666;">' )</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;shader:load ( vsh, fsh )</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;"> &nbsp;return shader</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #ff6666;">end</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /></ol></code></dd></dl><br /><br />I've debugged the shader code by setting different color values etc. and it looks like the problem happens when the worldMatrix ( MOAIShader.UNIFORM_WORLD) is added into the shader calculations (lines 81 &amp; 82 above). This was done to account for all transforms applied to the player character (for example scaling, rotation etc.) and as mentioned it works fine on desktops but freaks out on mobiles. <br /><br />Is there something particular to mobile graphics cards that needs to be accounted for with MOAIShader.UNIFORM_WORLD, is this an engine bug, or am I doing something wrong? Thanks.</div>

			

		</div>

		
			<dl class="postprofile" id="profile17522">
			<dt>
				<img src="../download/file.php%253favatar%253d1389_1402231553.jpg" width="100" height="100" alt="User avatar" /><br />
				<strong>sshukul</strong>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 87</dd><dd><strong>Joined:</strong> Wed Mar 27, 2013 8:44 am</dd>

		</dl>
	

		<div class="back2top"><a href="index.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p17528" class="post bg1">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			

			<h3 ><a href="index.html#p17528">Re: MOAIShader.UNIFORM_WORLD weird flickering on mobile devi</a></h3>
			<p class="author"><img src="../styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>JDance</strong> &raquo; Thu Aug 13, 2015 10:44 am </p>

			

			<div class="content">Very difficult question, not sure if we are experts enough on this forum!<br /><br />Only thing I can think of is that you have overlapping character pieces. You say that these pieces have different priorities so thats good - but if you use a depth buffer the pieces that are drawn later can still end up behind pieces that are drawn before. Maybe the world matrix rotation stuff messes with the z value a tiny bit and causes that. I'm not sure how to do it but if there is some depth buffer stuff going on try to disable all that. Apart from that I have no clue <img src="../images/smilies/icon_e_smile.gif" alt=":)" title="Smile" /><br /><br />Edit: Also, I'm not surprised the behavior is different on mobile, that happened to me many times, very annoying.</div>

			
				<div class="notice">Last edited by JDance on Thu Aug 13, 2015 10:49 am, edited 1 time in total.
					
				</div>
			

		</div>

		
			<dl class="postprofile" id="profile17528">
			<dt>
				<img src="../download/file.php%253favatar%253d1128_1359560257.jpg" width="98" height="99" alt="User avatar" /><br />
				<strong>JDance</strong>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 452</dd><dd><strong>Joined:</strong> Mon Oct 08, 2012 7:11 am</dd><dd><strong>Location:</strong> http://skyturns.se</dd>

		</dl>
	

		<div class="back2top"><a href="index.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p17529" class="post bg2">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			

			<h3 ><a href="index.html#p17529">Re: MOAIShader.UNIFORM_WORLD weird flickering on mobile devi</a></h3>
			<p class="author"><img src="../styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>JDance</strong> &raquo; Thu Aug 13, 2015 10:48 am </p>

			

			<div class="content">By the way that looks really awesome! I guess its a 2D image and you draw the characters shadow on that somehow?</div>

			

		</div>

		
			<dl class="postprofile" id="profile17529">
			<dt>
				<img src="../download/file.php%253favatar%253d1128_1359560257.jpg" width="98" height="99" alt="User avatar" /><br />
				<strong>JDance</strong>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 452</dd><dd><strong>Joined:</strong> Mon Oct 08, 2012 7:11 am</dd><dd><strong>Location:</strong> http://skyturns.se</dd>

		</dl>
	

		<div class="back2top"><a href="index.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p17533" class="post bg1">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			

			<h3 ><a href="index.html#p17533">Re: MOAIShader.UNIFORM_WORLD weird flickering on mobile devi</a></h3>
			<p class="author"><img src="../styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>ezraanderson</strong> &raquo; Thu Aug 13, 2015 3:00 pm </p>

			

			<div class="content">~<br />Is this all inside a framebuffer if so you need to init the buffer with z-depth, also if you are using 1.5 then the host would need to be patched for the framebuffer:init to work correctly with the z-buffer.</div>

			<div id="sig17533" class="signature">Dead Dark: A roguelike, zombie apocalypse survival game<br /><a href="http://www.ezraanderson.com" class="postlink">My Website</a> | <a href="https://www.facebook.com/ezraanderson1979" class="postlink">My Facebook</a> | <a href="https://twitter.com/ezraanderson79" class="postlink">My Twitter</a> | <a href="https://itunes.apple.com/us/artist/ezra-anderson/id477619040" class="postlink">My Games on Itunes</a> | <a href="https://play.google.com/store/apps/developer?id=Ezra+Anderson" class="postlink">My Games on Android</a></div>

		</div>

		
			<dl class="postprofile" id="profile17533">
			<dt>
				<img src="../download/file.php%253favatar%253d1202_1372191800.jpg" width="120" height="120" alt="User avatar" /><br />
				<strong>ezraanderson</strong>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 1036</dd><dd><strong>Joined:</strong> Wed Nov 21, 2012 9:24 pm</dd><dd><strong>Location:</strong> Canada</dd>

		</dl>
	

		<div class="back2top"><a href="index.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p17534" class="post bg2">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			

			<h3 ><a href="index.html#p17534">Re: MOAIShader.UNIFORM_WORLD weird flickering on mobile devi</a></h3>
			<p class="author"><img src="../styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>sshukul</strong> &raquo; Thu Aug 13, 2015 6:48 pm </p>

			

			<div class="content">Thanks for the replies guys ... it doesn't look like I'm using a depth buffer or frame buffer anywhere. I'm using the Rapanui framework for Moai ( <!-- m --><a class="postlink" href="https://github.com/ymobe/rapanui">https://github.com/ymobe/rapanui</a><!-- m --> ) which just seems to initialise a viewport and a couple of layers, and all of the props are placed on the main layer and I set the priorities manually. Should I be using depth or framebuffers then? <br /><br />Also thanks JDance, yes it's just a still 2D Image background with some animations on top such as falling leaves, water etc. and the character also on top animated with Spriter.  The shadows are just duplicates of the player props with color set to black and a blur shader applied. To make them fit every background scene I set shadow scale, rotation, alpha, blur and shear values per scene .. the shearing isn't exact so they won't line up and blend exactly into the feet all the time while walking, but with some trial and error it's possible to get them close enough to look realistic ... there's a post by nosheet about it here that I based it on <!-- l --><a class="postlink-local" href="../3d-shaders-let-s-share-code-here-t1820/index.html#p9961">3d-shaders-let-s-share-code-here-t1820/#p9961</a><!-- l -->.</div>

			

		</div>

		
			<dl class="postprofile" id="profile17534">
			<dt>
				<img src="../download/file.php%253favatar%253d1389_1402231553.jpg" width="100" height="100" alt="User avatar" /><br />
				<strong>sshukul</strong>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 87</dd><dd><strong>Joined:</strong> Wed Mar 27, 2013 8:44 am</dd>

		</dl>
	

		<div class="back2top"><a href="index.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p17540" class="post bg1">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			

			<h3 ><a href="index.html#p17540">Re: MOAIShader.UNIFORM_WORLD weird flickering on mobile devi</a></h3>
			<p class="author"><img src="../styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>JDance</strong> &raquo; Fri Aug 14, 2015 1:21 pm </p>

			

			<div class="content">Took a closer look at this. The main framebuffer is set up in the host code -- see for example the ios host: <!-- m --><a class="postlink" href="https://github.com/moai/moai-dev/blob/develop/src/host-ios/MOAIView.mm#L201">https://github.com/moai/moai-dev/blob/d ... ew.mm#L201</a><!-- m --><br /><br />Now I'm not an expert at what that does, or how to change it, but I think there is a depth buffer somewhere.<br /><br />It might be that you could mess with the props depth test, depth mask settings to work around this. See <!-- m --><a class="postlink" href="http://192.168.20.226:3000/docs/class_m_o_a_i_prop.html#acb62f205d63436a2c9d38e2aff14ab1d">/docs/class_m_o_a_i_p ... 2aff14ab1d</a><!-- m --><br /><br />Something like prop:setDepthTest(MOAIProp.DEPTH_TEST_DISABLE) to disable it, or prop:setDepthTest(MOAIProp.DEPTH_TEST_ALWAYS) to let the last drawn prop always win. I think they should be the same, and if my theory is correct, should stop flickering. But with OpenGL I'm wrong approx 95% of the time <img src="../images/smilies/icon_e_wink.gif" alt=";)" title="Wink" /></div>

			

		</div>

		
			<dl class="postprofile" id="profile17540">
			<dt>
				<img src="../download/file.php%253favatar%253d1128_1359560257.jpg" width="98" height="99" alt="User avatar" /><br />
				<strong>JDance</strong>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 452</dd><dd><strong>Joined:</strong> Mon Oct 08, 2012 7:11 am</dd><dd><strong>Location:</strong> http://skyturns.se</dd>

		</dl>
	

		<div class="back2top"><a href="index.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p17541" class="post bg2">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			

			<h3 ><a href="index.html#p17541">Re: MOAIShader.UNIFORM_WORLD weird flickering on mobile devi</a></h3>
			<p class="author"><img src="../styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>sshukul</strong> &raquo; Sat Aug 15, 2015 1:44 pm </p>

			

			<div class="content">Thanks again for looking more into it ... prop:setDepthTest(MOAIProp.DEPTH_TEST_DISABLE) and prop:setDepthTest(MOAIProp.DEPTH_TEST_ALWAYS) didn't seem to do anything, I'll see if playing with the depth buffer directly in the host affects it somehow. <br /><br />Is it fairly certain that it's related to z-ordering and depth issues though? I just suggested z-fighting because that's what nosheet thought it could be, but it may just be something with the UNIFORM_WORLD calculations themselves? Some similar threads in Unity for mobile mentioned draw call batching, maybe Moai's batching is having the same problems for mobiles?<br /><br />Because the parts flickering don't really have any other pieces behind them that they would be fighting with, there should only be the background and that has different colors than what the flickering is showing. Here's another example video where it's more clearly visible:<br /><br /><!-- m --><a class="postlink" href="https://www.youtube.com/watch?v=vt9x8Cdy2r8">https://www.youtube.com/watch?v=vt9x8Cdy2r8</a><!-- m --><br /><br /><img src="http://i.imgur.com/nHjPEjk.jpg" alt="Image" /></div>

			

		</div>

		
			<dl class="postprofile" id="profile17541">
			<dt>
				<img src="../download/file.php%253favatar%253d1389_1402231553.jpg" width="100" height="100" alt="User avatar" /><br />
				<strong>sshukul</strong>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 87</dd><dd><strong>Joined:</strong> Wed Mar 27, 2013 8:44 am</dd>

		</dl>
	

		<div class="back2top"><a href="index.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p17543" class="post bg1">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			

			<h3 ><a href="index.html#p17543">Re: MOAIShader.UNIFORM_WORLD weird flickering on mobile devi</a></h3>
			<p class="author"><img src="../styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>JDance</strong> &raquo; Mon Aug 17, 2015 8:02 am </p>

			

			<div class="content">Well if there is no overlap then its not z-fighting. If body parts dont overlap I guess you could test that once and for all by just hard coding a color in the fragment shading, like gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0); and see if any flickering occurs then.<br /><br />What got me thinking z-fighting was that the worldMatrix got applied in vertex shader, but now I realize that the gl_Position is not affected by worldMatrix at all. WorldMatrix just affects the fragment shader by those &quot;varying&quot;s. So some calculation probably freaks out in the fragment shader, but that stuff is hell to debug.<br /><br /><dl class="codebox"><dt>Code: <a href="index.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code style="line-height: 30%;"><ol class="c" style="font-family:monospace;"><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #993333;">float</span> d <span style="color: #339933;">=</span> <a href="http://www.opengroup.org/onlinepubs/009695399/functions/sqrt.html"><span style="color: #000066;">sqrt</span></a><span style="color: #009900;">&#40;</span>dot<span style="color: #009900;">&#40;</span>deltaPos<span style="color: #339933;">,</span> deltaPos<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #993333;">float</span> att <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span> attenuation.<span style="color: #202020;">x</span> <span style="color: #339933;">+</span> <span style="color: #009900;">&#40;</span>attenuation.<span style="color: #202020;">y</span><span style="color: #339933;">*</span>d<span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span> <span style="color: #009900;">&#40;</span>attenuation.<span style="color: #202020;">z</span><span style="color: #339933;">*</span>d<span style="color: #339933;">*</span>d<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></div></li><br /></ol></code></dd></dl><br />Something like this is total greek to me.. got to dive in real deep to get somewhere with that.<br /><br />If you havent tried it I would try changing those LOWP to MEDP or HIGHP (or what those are called). I have had issues with low precision on mobiles that did not show up on desptop - but not in the same situation as yours, so its a bit of a long shot but easy to try at least.<br /><br />Edit: I have no idea about draw call batching or how that could cause flickering, cant really see how. But then again this is black magic sometimes so who knows. If you got a link I could look at it.</div>

			

		</div>

		
			<dl class="postprofile" id="profile17543">
			<dt>
				<img src="../download/file.php%253favatar%253d1128_1359560257.jpg" width="98" height="99" alt="User avatar" /><br />
				<strong>JDance</strong>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 452</dd><dd><strong>Joined:</strong> Mon Oct 08, 2012 7:11 am</dd><dd><strong>Location:</strong> http://skyturns.se</dd>

		</dl>
	

		<div class="back2top"><a href="index.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p17584" class="post bg2">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			

			<h3 ><a href="index.html#p17584">Re: MOAIShader.UNIFORM_WORLD weird flickering on mobile devi</a></h3>
			<p class="author"><img src="../styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>ezraanderson</strong> &raquo; Wed Sep 02, 2015 7:34 pm </p>

			

			<div class="content">~<br />Did you figure this out?</div>

			<div id="sig17584" class="signature">Dead Dark: A roguelike, zombie apocalypse survival game<br /><a href="http://www.ezraanderson.com" class="postlink">My Website</a> | <a href="https://www.facebook.com/ezraanderson1979" class="postlink">My Facebook</a> | <a href="https://twitter.com/ezraanderson79" class="postlink">My Twitter</a> | <a href="https://itunes.apple.com/us/artist/ezra-anderson/id477619040" class="postlink">My Games on Itunes</a> | <a href="https://play.google.com/store/apps/developer?id=Ezra+Anderson" class="postlink">My Games on Android</a></div>

		</div>

		
			<dl class="postprofile" id="profile17584">
			<dt>
				<img src="../download/file.php%253favatar%253d1202_1372191800.jpg" width="120" height="120" alt="User avatar" /><br />
				<strong>ezraanderson</strong>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 1036</dd><dd><strong>Joined:</strong> Wed Nov 21, 2012 9:24 pm</dd><dd><strong>Location:</strong> Canada</dd>

		</dl>
	

		<div class="back2top"><a href="index.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p17590" class="post bg1">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			

			<h3 ><a href="index.html#p17590">Re: MOAIShader.UNIFORM_WORLD weird flickering on mobile devi</a></h3>
			<p class="author"><img src="../styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>sshukul</strong> &raquo; Fri Sep 04, 2015 11:32 pm </p>

			

			<div class="content">@ezra .. not yet, a 2 week holiday just put everything major on hold. Got back today, will look at this again tomorrow.</div>

			

		</div>

		
			<dl class="postprofile" id="profile17590">
			<dt>
				<img src="../download/file.php%253favatar%253d1389_1402231553.jpg" width="100" height="100" alt="User avatar" /><br />
				<strong>sshukul</strong>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 87</dd><dd><strong>Joined:</strong> Wed Mar 27, 2013 8:44 am</dd>

		</dl>
	

		<div class="back2top"><a href="index.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p17593" class="post bg2">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			

			<h3 ><a href="index.html#p17593">Re: MOAIShader.UNIFORM_WORLD weird flickering on mobile devi</a></h3>
			<p class="author"><img src="../styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>sshukul</strong> &raquo; Sat Sep 05, 2015 2:17 pm </p>

			

			<div class="content">HIGHP precision fixed it! Such a simple thing (as these things usually are after scratching heads for days <img src="../images/smilies/icon_e_biggrin.gif" alt=":D" title="Very Happy" /> ), thanks JDance! <br /><br />I'd actually thought of it before and changed to MEDP which didn't work, then tried HIGHP which gave shader syntax errors on my desktop so I thought maybe it just doesn't work with most OpenGLs or something. <br /><br />But after you recommended again here, I decided to test the HIGHP precision directly on mobiles regardless of the errors on desktop. That fixed the issue, at least on the mobiles I have. <br /><br />For now I'm thinking of just checking within lua whether it's desktop or mobile (like if MOAIAppAndroid ~= nil or MOAIAppIOS ~= nil) and setting the precisions in the shaders accordingly. But I'm worried if this is something linked to OpenGL version then it's not simply a desktop vs mobile thing but can vary from device to device. So maybe doing it like this will make the shader fail on some mobiles which also have older OpenGL versions without highp definitions ... would it be better to check it with some GLSL preprocessor directives like so?<br /><br /><dl class="codebox"><dt>Code: <a href="index.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code style="line-height: 30%;"><ol class="glsl" style="font-family:monospace;"><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #009900;">#ifdef GL_FRAGMENT_PRECISION_HIGH</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #009900;"># define maxfragp highp</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #009900;">#else</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #009900;"># define maxfragp medp</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #009900;">#endif</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /></ol></code></dd></dl><br /><br />as per the second response here:<br /><!-- m --><a class="postlink" href="http://stackoverflow.com/questions/20126918/precision-qualifier-throws-an-error-for-opengl-3-0-under-mesa-9-2-1">http://stackoverflow.com/questions/2012 ... mesa-9-2-1</a><!-- m --><br /><br />I tried setting the preprocessor macros within the shaders themselves but it complains about not being the first statement. Where would these be set within Moai? Or am I overthinking things and should be fine with just the mobile vs desktop check?</div>

			

		</div>

		
			<dl class="postprofile" id="profile17593">
			<dt>
				<img src="../download/file.php%253favatar%253d1389_1402231553.jpg" width="100" height="100" alt="User avatar" /><br />
				<strong>sshukul</strong>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 87</dd><dd><strong>Joined:</strong> Wed Mar 27, 2013 8:44 am</dd>

		</dl>
	

		<div class="back2top"><a href="index.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p17599" class="post bg1">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			

			<h3 ><a href="index.html#p17599">Re: MOAIShader.UNIFORM_WORLD weird flickering on mobile devi</a></h3>
			<p class="author"><img src="../styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>JDance</strong> &raquo; Sun Sep 06, 2015 5:41 pm </p>

			

			<div class="content">Wow great that it worked! Haha really nice <img src="../images/smilies/icon_e_smile.gif" alt=":)" title="Smile" /><br /><br />I would not worry about it not working on different devices, there seems to be thousands of opengl versions for desktop, but for mobile its pretty much just &quot;opengl ES&quot;, and thats a standard and should be no problem. I'm not completely sure but I cant remember any shader problems between android and iOS ever.<br /><br />I would not take the advice from that stackoverflow post since it is about desktop opengl. That define may not be set for opengl ES.<br /><br />So just go with the mobile thing. If you are compiling the host yourself there is code for those HIGHP definitions in the ShaderMgr or somewhere around there, but I wouldnt bother it its a lua quick fix!</div>

			

		</div>

		
			<dl class="postprofile" id="profile17599">
			<dt>
				<img src="../download/file.php%253favatar%253d1128_1359560257.jpg" width="98" height="99" alt="User avatar" /><br />
				<strong>JDance</strong>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 452</dd><dd><strong>Joined:</strong> Mon Oct 08, 2012 7:11 am</dd><dd><strong>Location:</strong> http://skyturns.se</dd>

		</dl>
	

		<div class="back2top"><a href="index.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<form id="viewtopic" method="post" action="index.html">

	<fieldset class="display-options" style="margin-top: 0; ">
		
	</fieldset>

	</form>
	<hr />


<div class="topic-actions">
	<div class="buttons">
	
	</div>

	
		<div class="pagination">
			12 posts
			 &bull; Page <strong>1</strong> of <strong>1</strong>
		</div>
	
</div>


	<p></p><p><a href="../moai-sdk-developer-support.html" class="left-box left" accesskey="r">Return to Moai SDK</a></p>

	<form method="post" id="jumpbox" action="http://192.168.20.226:3000/forums/viewforum.php" onsubmit="if(document.jumpbox.f.value == -1){return false;}">

	
		<fieldset class="jumpbox">
	
			<label for="f" accesskey="j">Jump to:</label>
			<select name="f" id="f" onchange="if(this.options[this.selectedIndex].value != -1){ document.forms['jumpbox'].submit() }">
			
				<option value="-1">Select a forum</option>
			<option value="-1">------------------</option>
				<option value="4">Moai Development Forums</option>
			
				<option value="7" selected="selected">&nbsp; &nbsp;Moai SDK</option>
			
				<option value="9">&nbsp; &nbsp;Questions and Tips</option>
			
				<option value="10">&nbsp; &nbsp;Bug Reports</option>
			
				<option value="29">&nbsp; &nbsp;Reviewers</option>
			
				<option value="3">Moai Community Forums</option>
			
				<option value="11">&nbsp; &nbsp;Community Contributions</option>
			
				<option value="25">&nbsp; &nbsp;&nbsp; &nbsp;Flower</option>
			
				<option value="28">&nbsp; &nbsp;&nbsp; &nbsp;Rapanui</option>
			
				<option value="26">&nbsp; &nbsp;&nbsp; &nbsp;Snippets</option>
			
				<option value="5">&nbsp; &nbsp;Moai Roadmap</option>
			
				<option value="8">&nbsp; &nbsp;&nbsp; &nbsp;Moai Cloud</option>
			
				<option value="6">&nbsp; &nbsp;Made With Moai</option>
			
				<option value="12">Platform Specifics</option>
			
				<option value="17">&nbsp; &nbsp;Android</option>
			
				<option value="18">&nbsp; &nbsp;Apple</option>
			
				<option value="20">&nbsp; &nbsp;Linux</option>
			
				<option value="19">&nbsp; &nbsp;Windows</option>
			
				<option value="21">&nbsp; &nbsp;Browser + Other</option>
			
				<option value="13">Third Party Libraries and Plugins</option>
			
				<option value="22">&nbsp; &nbsp;Physics</option>
			
				<option value="23">&nbsp; &nbsp;Sound + Music</option>
			
				<option value="24">&nbsp; &nbsp;Advertising + Networking + IAPs</option>
			
				<option value="14">Additional</option>
			
				<option value="16">&nbsp; &nbsp;Game Development</option>
			
				<option value="27">&nbsp; &nbsp;Off Topic</option>
			
			</select>
			<input type="submit" value="Go" class="button2" />
		</fieldset>
	</form>


	<h3>Who is online</h3>
	<p>Users browsing this forum: No registered users and 0 guests</p>
</div>

<div id="page-footer">

	<div class="navbar">
		<div class="inner"><span class="corners-top"><span></span></span>

		<ul class="linklist">
			<li class="icon-home"><a href="../index.html" accesskey="h">Board index</a></li>
				
			<li class="rightside">All times are UTC </li>
		</ul>

		<span class="corners-bottom"><span></span></span></div>
	</div>
	
	<div class="copyright">Powered by <a href="http://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Group<br />Style by <a href="http://www.m-a-styles.de">Marc Alexander</a> &copy;
		<br /><br /><a href="http://www.phpbb-seo.com/" title="Search Engine Optimization"><img src="../images/phpbb-seo.png" alt="phpBB SEO"/></a><br />Time : 0.075s | 11 Queries | GZIP : Off
	</div>
</div>

</div>

<div>
	<a id="bottom" name="bottom" accesskey="z"></a>
	
	</div>
	</div>
<div class="nobottomgap"></div>
</div>
<!--- end of box border -->
</div></div>
<!-- -->
<div class="bottom-left"></div><div class="bottom-center"></div><div class="bottom-right"></div>
</div>
<!-- JQuery Pop Up --><!-- PM Popup --><!-- PM Popup end --><!-- Image Popup -->
<div id="popupImage">
	<p id="ImagePopup"></p>
	<a id="popupImageClose">x</a> 
</div>
<!-- Image Popup -->
<div id="backgroundPopup"></div> 
<!-- JQuery Pop Up END -->
</body>
</html>