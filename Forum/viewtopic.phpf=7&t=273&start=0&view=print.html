<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />
<meta name="robots" content="noindex" />

<title>Moai Forum &bull; View topic - Releasing Texture Memory</title>

<link href="styles/proFormell/theme/print.css" rel="stylesheet" type="text/css" />
<link type="image/vnd.microsoft.icon" rel="shortcut icon" href="styles/proFormell/theme/images/favicon.ico">
</head>

<body id="phpbb">
<div id="wrap">
	<a id="top" name="top" accesskey="t"></a>

	<div id="page-header">
		<h1>Moai Forum</h1>
		<p>The mobile platform for pro game developers<br /><a href="index.html">/forums/</a></p>

		<h2>Releasing Texture Memory</h2>
		<p><a href="releasing-texture-memory-t273/index.html">/forums/releasing-texture-memory-t273/</a></p>
	</div>

	<div id="page-body">
		<div class="page-number">Page <strong>1</strong> of <strong>1</strong></div>
		
			<div class="post">
				<h3>Releasing Texture Memory</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Sat Dec 17, 2011 1:11 am</strong></div>
				<div class="author">by <strong>develop</strong></div>
				<div class="content">When creating a prop with a texture as such
<br />
<br /><em>btn.gfx = MOAIGfxQuad2D.new()	</em>
<br />
<br /><em>btn.gfx:setTexture("btnStart.png")	</em>
<br />
<br /><em>btn.gfx:setRect(-256,-128,256,128)	</em>
<br />
<br /><em>btn.prop = MOAIProp2D.new()	</em>
<br />
<br /><em>btn.prop:setDeck(btn.gfx)</em>
<br />
<br /><em>	l:insertProp(btn.prop)</em>
<br />
<br />
<br />
<br />is there a way to automatically free the texture memory when the object is destroyed?
<br />
<br />I am currently removing the prop from the layer using l:clear() and setting btn to <em>nil</em> but the the memory footprint shows that the texture memory is not released.
<br />
<br />Am I missing something or will I have to track textures and then call release on them manually?</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Releasing Texture Memory</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Sat Dec 17, 2011 8:46 am</strong></div>
				<div class="author">by <strong>bonozogames</strong></div>
				<div class="content">I have not tried it, but I plan to see if <a href="http://192.168.20.226:3000/docs/class_m_o_a_i_sim.html#a68c8298729457a936d7b35e2466def09" target="_blank">MOAISim.forceGarbageCollection</a> does the trick.
<br />
<br />From my experience with Lua and Moai, the textures free when you need more room to add more, and/or over-time.  If you create a lot of texture props, you'll see the old ones free (i.e. "[-]" in the debug window) then.
<br />
<br />
<br />Lua itself has a few configurable garbage collection parameters.  I've always configured it from "C", not inside Lua, yet.</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Releasing Texture Memory</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Sat Dec 17, 2011 9:46 am</strong></div>
				<div class="author">by <strong>develop</strong></div>
				<div class="content">Unfortunately, that isn't our bottleneck.
<br />
<br />Forcing GC didn't free up the resources (no [-] spotted yet) and running the creation and destruction of textures and props in loops leads to the devices crashing once their memory is exhausted.
<br />
<br />But it's good to know I'm not missing anything in principle. There's probably a reference left somewhere.
<br />
<br />(If there is a good way to track references in Moai, input would be most appreciated)</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Releasing Texture Memory</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Sat Dec 17, 2011 9:52 am</strong></div>
				<div class="author">by <strong>bonozogames</strong></div>
				<div class="content">This is an excellent topic.
<br />
<br />After any layer.clear() or removeProp(), I set the variable (if not local) pointing to it, if any, to nil. </div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Releasing Texture Memory</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Sat Dec 17, 2011 11:07 am</strong></div>
				<div class="author">by <strong>bonozogames</strong></div>
				<div class="content">What method do you use to check the "memory footprint" ?</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Releasing Texture Memory</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Sat Dec 17, 2011 11:14 am</strong></div>
				<div class="author">by <strong>develop</strong></div>
				<div class="content">Either the simulators output
<br />
<br />(e.g. TEXTURE: '+'      65536 =   8.38MB < object.png)
<br />
<br />or Xcode's profiling tools (Allocations, Leaks and VMTracker).
<br />
<br />
<br />
<br />I actually found about half of the problems:
<br />
<br />The texture memory used for fonts is not released even when set to nil. Other objects release fine.
<br />
<br />Also, one of our tables used to keep track of allocated objects is overwritten somewhere.
<br />
<br />
<br />
<br />Tracking that down now. After it is fixed, I'll push the first (hopefully) memory sane and usable version of our scene manager to GitHub.</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Releasing Texture Memory</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Sat Dec 17, 2011 11:31 am</strong></div>
				<div class="author">by <strong>develop</strong></div>
				<div class="content">Alright, fixed.
<br />
<br />For anyone with a similar issue who may find this thread in the future:
<br />
<br />
<br />
<br />We mismanaged the stack of tables that held our objects and thus tried setting the same batch of objects to nil over and over if an animation was used in the scene manager. We'd do some clean up on the layer, then push the new layer, then transition and then finalize cleaning of the top-most scene. As time had passed between the initial call and the final cleaning the new layer was now the newest scene which we promptly discarded.
<br />
<br />
<br />
<br />Either way, a non-leaking version of our basic scene manager is now up.</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Releasing Texture Memory</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Mon Dec 19, 2011 12:06 am</strong></div>
				<div class="author">by <strong>patrick</strong></div>
				<div class="content">Very cool.
<br />
<br />This may be moot, but FWIW we use the histogram a lot internally. Check out MOAISim.setHistogramEnabled and MOAISim.reportHistogram.
<br />
<br />There's also AKUSoftReleaseGfxResources and MOAITexture.release () but... YMMV!</div>
			</div>
			<hr />
		
	</div>

	<div id="page-footer">
		<div class="page-number">All times are UTC <br />Page <strong>1</strong> of <strong>1</strong></div>
		<div class="copyright">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</div>
	</div>
</div>

</body>
</html>