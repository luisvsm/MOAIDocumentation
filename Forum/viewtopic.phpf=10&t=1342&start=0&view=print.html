<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />
<meta name="robots" content="noindex" />

<title>Moai Forum &bull; View topic - Camera, projection matrix and viewport size to scale ratio</title>

<link href="styles/proFormell/theme/print.css" rel="stylesheet" type="text/css" />
<link type="image/vnd.microsoft.icon" rel="shortcut icon" href="styles/proFormell/theme/images/favicon.ico">
</head>

<body id="phpbb">
<div id="wrap">
	<a id="top" name="top" accesskey="t"></a>

	<div id="page-header">
		<h1>Moai Forum</h1>
		<p>The mobile platform for pro game developers<br /><a href="index.html">/forums/</a></p>

		<h2>Camera, projection matrix and viewport size to scale ratio</h2>
		<p><a href="camera-projection-matrix-and-viewport-size-to-scale-ratio-t1342/index.html">/forums/camera-projection-matrix-and-viewport-size-to-scale-ratio-t1342/</a></p>
	</div>

	<div id="page-body">
		<div class="page-number">Page <strong>1</strong> of <strong>1</strong></div>
		
			<div class="post">
				<h3>Camera, projection matrix and viewport size to scale ratio</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Mon Oct 29, 2012 2:37 pm</strong></div>
				<div class="author">by <strong>JDance</strong></div>
				<div class="content">So I had a project with viewport size 480*320 and scale 480*320. With it I had a 3D-scene and a camera with FOV 60 overlooking my level.<br /><br />I decided to change my project scale to around 100 for various reasons so that my viewport size was still 480*320 but my scale was 133 * 100. Strangely this messed up my camera and resulted in a heavily zoomed in view of the level. I was confused since I thought the 3D-world projection stuff would work in -1, 1 coordinates and not be affected by scaling of the viewport.<br /><br />After messing around for a while I managed to get the thing to look right again by increasing the FOV to about 130. So what does FOV have to do with viewport scale?<br /><br />Source code from MOAICamera.cpp<br /><br /><dl class="codebox"><dt>Code: <a href="viewtopic.php%3Ff=10&amp;t=1342&amp;start=0&amp;view=print.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code style="line-height: 30%;"><ol class="cpp" style="font-family:monospace;"><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">USVec2D viewScale <span style="color: #000080;">=</span> viewport.<span style="color: #007788;">GetScale</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; </div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span> this<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>mOrtho <span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">float</span> xs <span style="color: #000080;">=</span> <span style="color: #008000;">&#40;</span> <span style="color:#800080;">2.0f</span> <span style="color: #000040;">/</span> viewport.<span style="color: #007788;">Width</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span> <span style="color: #000040;">*</span> viewScale.<span style="color: #007788;">mX</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">float</span> ys <span style="color: #000080;">=</span> <span style="color: #008000;">&#40;</span> <span style="color:#800080;">2.0f</span> <span style="color: #000040;">/</span> viewport.<span style="color: #007788;">Height</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span> <span style="color: #000040;">*</span> viewScale.<span style="color: #007788;">mY</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; mtx.<span style="color: #007788;">Ortho</span> <span style="color: #008000;">&#40;</span> xs, ys, this<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>mNearPlane, this<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>mFarPlane <span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #008000;">&#125;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0000ff;">else</span> <span style="color: #008000;">&#123;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">float</span> xs <span style="color: #000080;">=</span> Cot <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#40;</span> this<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>mFieldOfView <span style="color: #000040;">*</span> <span style="color: #008000;">&#40;</span> <span style="color: #0000ff;">float</span> <span style="color: #008000;">&#41;</span>D2R <span style="color: #008000;">&#41;</span> <span style="color: #000040;">/</span> <span style="color:#800080;">2.0f</span> <span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">float</span> ys <span style="color: #000080;">=</span> xs <span style="color: #000040;">*</span> viewport.<span style="color: #007788;">GetAspect</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; xs <span style="color: #000040;">*</span><span style="color: #000080;">=</span> viewScale.<span style="color: #007788;">mX</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; ys <span style="color: #000040;">*</span><span style="color: #000080;">=</span> viewScale.<span style="color: #007788;">mY</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; mtx.<span style="color: #007788;">Perspective</span> <span style="color: #008000;">&#40;</span> xs, ys, this<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>mNearPlane, this<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>mFarPlane <span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #008000;">&#125;</span></div></li><br /></ol></code></dd></dl><br /><br />You would want to look in the second, non ortho part. Viewscale here is confusing, it is not the scale on the view port, but rather the ratio between viewport.size and viewport.scale. The viewport size to scale ratio is then used to create the perspective matrix, explaining our problem. Originally with my 480 size, 480 scale setup I had a viewport size to scale ratio of 1, and 3D was working as intended. As that ratio changed to 480 to 133 (and will change all the time due to different device resolutions, say 640 to 133), my scene will have a different camera for every screen size.<br /><br />Simply removing<br /><dl class="codebox"><dt>Code: <a href="viewtopic.php%3Ff=10&amp;t=1342&amp;start=0&amp;view=print.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code style="line-height: 30%;"><ol class="cpp" style="font-family:monospace;"><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">xs <span style="color: #000040;">*</span><span style="color: #000080;">=</span> viewScale.<span style="color: #007788;">mX</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">ys <span style="color: #000040;">*</span><span style="color: #000080;">=</span> viewScale.<span style="color: #007788;">mY</span><span style="color: #008080;">;</span></div></li><br /></ol></code></dd></dl><br />effectively solves this problem, and I have done so in my moai-dev fork.<br /><br />I am new to 3D development and don't know much about frustum math and projection so I really don't know what the practice is here. If this is working as intended, could you guide me to how I setup my camera correctly? If it's a bug, it would be awesome if you fixed it:)</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: Camera, projection matrix and viewport size to scale rat</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Tue Nov 06, 2012 6:59 pm</strong></div>
				<div class="author">by <strong>dustar</strong></div>
				<div class="content">wouldn't the scale be 150*100?</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: Camera, projection matrix and viewport size to scale rat</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Wed Nov 07, 2012 8:40 am</strong></div>
				<div class="author">by <strong>JDance</strong></div>
				<div class="content">Yeah thats true, I messed up some numbers there. Shouldn't make a difference for the problem though!<br /><br />Thinking about this some more an easy solution would probably be to always use a viewport for 3D-scenes where the scale is the same as the size. Then you can use other viewports for 2D-stuff like GUI to handle screen size differences etc. The way I understand it the viewport is really just a size/scale configuration and is not a &quot;physical&quot; object or part of the screen.</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: Camera, projection matrix and viewport size to scale rat</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Thu Nov 08, 2012 12:55 am</strong></div>
				<div class="author">by <strong>adam</strong></div>
				<div class="content">Yes the viewport scale is just intended to scale the viewport and work with 2D coordinates. For example if you have a scene with a window size of 320x480, a scale of 160x240 and an object that has a width of 128, the object would appear to be double that ( 256 ) on the actual window.<br /><br />So, in your case you set the 'coordinate system' of the viewport to be almost a third the size of the window, so it caused it to 'zoom in' to about 3 times the size.<br /><br />What you want to adjust in 3D coordinates to correct this is the World Matrix to adjust the scale of the 3D scene. Also, adjusting the FOV to adjust the scale is generally a bad idea ( can cause some weird effects later in your games ).</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: Camera, projection matrix and viewport size to scale rat</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Thu Nov 08, 2012 7:31 am</strong></div>
				<div class="author">by <strong>JDance</strong></div>
				<div class="content">Hey, thanks for answering!<br /><br />How do I adjust the world matrix then? I tried messing with the camera without success.<br /><br />And what is really the purpose of viewport scale to size ratio changing the perspective matrix?<br /><br />The problem is essentially solved by now by always settings the 3D-viewport scale to the same as the size, but it would be interesting to know what the best practice is.</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: Camera, projection matrix and viewport size to scale rat</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Thu Nov 08, 2012 10:16 pm</strong></div>
				<div class="author">by <strong>adam</strong></div>
				<div class="content">Well, short of scaling all the props ( its transform would be our world/model matrix ), you can scale the Camera Matrix as well to get that effect.</div>
			</div>
			<hr />
		
	</div>

	<div id="page-footer">
		<div class="page-number">All times are UTC <br />Page <strong>1</strong> of <strong>1</strong></div>
		<div class="copyright">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</div>
	</div>
</div>

</body>
</html>