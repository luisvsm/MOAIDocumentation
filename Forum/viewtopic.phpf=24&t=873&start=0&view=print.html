<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />
<meta name="robots" content="noindex" />

<title>Moai Forum &bull; View topic - Google in-app purchase crashing</title>

<link href="styles/proFormell/theme/print.css" rel="stylesheet" type="text/css" />
<link type="image/vnd.microsoft.icon" rel="shortcut icon" href="styles/proFormell/theme/images/favicon.ico">
</head>

<body id="phpbb">
<div id="wrap">
	<a id="top" name="top" accesskey="t"></a>

	<div id="page-header">
		<h1>Moai Forum</h1>
		<p>The mobile platform for pro game developers<br /><a href="index.html">/forums/</a></p>

		<h2>Google in-app purchase crashing</h2>
		<p><a href="google-in-app-purchase-crashing-t873/index.html">/forums/google-in-app-purchase-crashing-t873/</a></p>
	</div>

	<div id="page-body">
		<div class="page-number">Page <strong>1</strong> of <strong>1</strong></div>
		
			<div class="post">
				<h3>Google in-app purchase crashing</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Tue Jun 12, 2012 2:45 pm</strong></div>
				<div class="author">by <strong>paxtonhare</strong></div>
				<div class="content">I'm getting fairly consistent crashes on my android test device (LG Ally with 2.2) when making a Google in-app purchase using Moai SDK 1.1.<br /><br />After the successful purchase MOAIRenderMgr sometimes has an invalid mRenderTable.<br /><br />Here are two stack dumps that I'm getting (the crash alternates between the two:<br /><br /><blockquote class="uncited"><div>signal 11 (SIGSEGV), fault addr 0000001c<br />Stack frame #00  pc 004a000c  libmoai.so: Routine luaH_getnum in moai-beta/ant/libmoai/jni/../../../3rdparty/lua-5.1.3/src/ltable.c:437<br />Stack frame #01  pc 004876c0  libmoai.so: Routine lua_rawgeti in moai-beta/ant/libmoai/jni/../../../3rdparty/lua-5.1.3/src/lapi.c:573<br />Stack frame #02  pc 001d9544  libmoai.so: Routine RenderTable in moai-beta/ant/libmoai/jni/../../../src/moaicore/MOAIRenderMgr.cpp:169<br />Stack frame #03  pc 001d9468  libmoai.so: Routine Render in moai-beta/ant/libmoai/jni/../../../src/moaicore/MOAIRenderMgr.cpp:152<br />Stack frame #04  pc 001a2688  libmoai.so: Routine AKURender in moai-beta/ant/libmoai/jni/../../../src/aku/AKU.cpp:297<br />Stack frame #05  pc 0019db78  libmoai.so: Routine Java_com_ziplinegames_moai_Moai_AKURender in moai-beta/ant/libmoai/jni/src/moai.cpp:348</div></blockquote><br /><br /><blockquote class="uncited"><div>signal 7 (SIGBUS), fault addr 00000000<br />Stack frame #00  pc 004876a8  libmoai.so: Routine lua_rawgeti in moai-beta/ant/libmoai/jni/../../../3rdparty/lua-5.1.3/src/lapi.c:574<br />Stack frame #01  pc 001d9518  libmoai.so: Routine RenderTable in moai-beta/ant/libmoai/jni/../../../src/moaicore/MOAIRenderMgr.cpp:169<br />Stack frame #02  pc 001d9468  libmoai.so: Routine Render in moai-beta/ant/libmoai/jni/../../../src/moaicore/MOAIRenderMgr.cpp:152<br />libmoai.so: Routine AKURender in moai-beta/ant/libmoai/jni/../../../src/aku/AKU.cpp:297<br />Stack frame #04  pc 0019db78  libmoai.so: Routine Java_com_ziplinegames_moai_Moai_AKURender in moai-beta/ant/libmoai/jni/src/moai.cpp:348<br />Stack frame #05  pc 00011074  /system/lib/libdvm.so<br />Stack frame #06  pc 0003b7b8  /system/lib/libdvm.so</div></blockquote><br /><br />I've been able to narrow it down to the fact that I have a MOAIBilling.PURCHASE_STATE_CHANGED callback present.<br /><br />When I have this code it dies:<br /><br /><dl class="codebox"><dt>Code: <a href="viewtopic.php%3Ff=24&amp;t=873&amp;start=0&amp;view=print.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code style="line-height: 30%;"><ol class="lua" style="font-family:monospace;"><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #aa9900; font-weight: bold;">function</span> onPurchaseStateChanged <span style="color: #66cc66;">&#40;</span> code<span style="color: #66cc66;">,</span> id<span style="color: #66cc66;">,</span> order<span style="color: #66cc66;">,</span> user<span style="color: #66cc66;">,</span> notification<span style="color: #66cc66;">,</span> payload <span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #aa9900; font-weight: bold;">end</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">MOAIBilling<span style="color: #66cc66;">.</span>setListener <span style="color: #66cc66;">&#40;</span> MOAIBilling<span style="color: #66cc66;">.</span>PURCHASE_STATE_CHANGED<span style="color: #66cc66;">,</span> onPurchaseStateChanged <span style="color: #66cc66;">&#41;</span></div></li><br /></ol></code></dd></dl><br /><br />Yet when I comment out the setListener call it no longer crashes. I can only figure it's some sort of wacky threading issue.<br /><br /><dl class="codebox"><dt>Code: <a href="viewtopic.php%3Ff=24&amp;t=873&amp;start=0&amp;view=print.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code style="line-height: 30%;"><ol class="lua" style="font-family:monospace;"><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #aa9900; font-weight: bold;">function</span> onPurchaseStateChanged <span style="color: #66cc66;">&#40;</span> code<span style="color: #66cc66;">,</span> id<span style="color: #66cc66;">,</span> order<span style="color: #66cc66;">,</span> user<span style="color: #66cc66;">,</span> notification<span style="color: #66cc66;">,</span> payload <span style="color: #66cc66;">&#41;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #aa9900; font-weight: bold;">end</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #808080; font-style: italic;">--MOAIBilling.setListener ( MOAIBilling.PURCHASE_STATE_CHANGED, onPurchaseStateChanged )</span></div></li><br /></ol></code></dd></dl><br /><br />Can anyone assist me in debugging this?<br /><br />Thanks,<br /><br />--Paxton</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: Google in-app purchase crashing</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Tue Jun 12, 2012 3:09 pm</strong></div>
				<div class="author">by <strong>ibisum</strong></div>
				<div class="content">This looks like parameters are not being passed to onPurchaseStateChanged() properly - perhaps you're getting a string when the Lua VM is expecting an Integer, and so on .. if possible, change the onPurchaseStateChanged() function signature to a 'varargs' style, then parse (and unpack) the args to find out what type is being passed in .. See here for reference how to do such things:<br /><br /><!-- m --><a class="postlink" href="http://lua-users.org/wiki/VarargTheSecondClassCitizen">http://lua-users.org/wiki/VarargTheSecondClassCitizen</a><!-- m --></div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: Google in-app purchase crashing</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Tue Jun 12, 2012 5:59 pm</strong></div>
				<div class="author">by <strong>paxtonhare</strong></div>
				<div class="content">ibisum,<br /><br />Thanks for the suggestion. I don't think it's a parameter mismatch. I followed your suggestion and found that the types are coming across correctly. <br /><br />While this crash happens a lot, it is still intermittent. <br /><br />I'm still thinking this has something to do with threads or memory spaces. I added a debug print statement to MOAIRenderMgr.cpp line 169:<br /><br /><dl class="codebox"><dt>Code: <a href="viewtopic.php%3Ff=24&amp;t=873&amp;start=0&amp;view=print.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code style="line-height: 30%;"><ol class="cpp" style="font-family:monospace;"><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0000ff;">void</span> MOAIRenderMgr<span style="color: #008080;">::</span><span style="color: #007788;">RenderTable</span> <span style="color: #008000;">&#40;</span> MOAILuaState<span style="color: #000040;">&amp;</span> state, <span style="color: #0000ff;">int</span> idx <span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; idx <span style="color: #000080;">=</span> state.<span style="color: #007788;">AbsIndex</span> <span style="color: #008000;">&#40;</span> idx <span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; <span style="color: #0000ff;">int</span> n <span style="color: #000080;">=</span> <span style="color: #0000dd;">1</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; <span style="color: #0000ff;">while</span> <span style="color: #008000;">&#40;</span> n <span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; <span style="color: #666666;">// I ADDED THIS PRINT STATEMENT</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; USLog<span style="color: #008080;">::</span><span style="color: #007788;">PrintFile</span> <span style="color: #008000;">&#40;</span> USLog<span style="color: #008080;">::</span><span style="color: #007788;">CONSOLE</span>, <span style="color: #FF0000;">&quot;MOAIRenderMgr::RenderTable n = %d&quot;</span>, n<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; lua_rawgeti <span style="color: #008000;">&#40;</span> state, idx, n<span style="color: #000040;">++</span> <span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span> &nbsp;<span style="color: #666666;">// &lt;-- THIS IS WHERE IT'S CRASHING</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; <span style="color: #0000ff;">int</span> valType <span style="color: #000080;">=</span> lua_type <span style="color: #008000;">&#40;</span> state, <span style="color: #000040;">-</span><span style="color: #0000dd;">1</span> <span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; </div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; <span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span> valType <span style="color: #000080;">==</span> LUA_TUSERDATA <span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; MOAIRenderable<span style="color: #000040;">*</span> renderable <span style="color: #000080;">=</span> state.<span style="color: #007788;">GetLuaObject</span> <span style="color: #000080;">&lt;</span> MOAIRenderable <span style="color: #000080;">&gt;</span><span style="color: #008000;">&#40;</span> <span style="color: #000040;">-</span><span style="color: #0000dd;">1</span>, <span style="color: #0000ff;">false</span> <span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span> renderable <span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; &nbsp; renderable<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>Render <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; <span style="color: #008000;">&#125;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; <span style="color: #008000;">&#125;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span> valType <span style="color: #000080;">==</span> LUA_TTABLE <span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; this<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>RenderTable <span style="color: #008000;">&#40;</span> state, <span style="color: #000040;">-</span><span style="color: #0000dd;">1</span> <span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; <span style="color: #008000;">&#125;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; <span style="color: #0000ff;">else</span> <span style="color: #008000;">&#123;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; &nbsp; n <span style="color: #000080;">=</span> <span style="color: #0000dd;">0</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; <span style="color: #008000;">&#125;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; &nbsp; lua_pop <span style="color: #008000;">&#40;</span> state, <span style="color: #0000dd;">1</span> <span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; <span style="color: #008000;">&#125;</span></div></li><br /><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #008000;">&#125;</span></div></li><br /></ol></code></dd></dl><br /><br />I'm seeing a consistent pattern in the logs when the app crashes:<br /><br />Non-crash:<br /><blockquote class="uncited"><div>I/MoaiLog (16569): MOAIRenderMgr::RenderTable n = 1<br />I/MoaiLog (16569): [debug]	onPurchaseStateChanged<br />I/MoaiLog (16569): [debug]	0:number	android.test.purchased:string	transactionId.android.test.purchased:string	<br />I/MoaiLog (16569): MOAIRenderMgr::RenderTable n = 2<br />I/MoaiLog (16569): MOAIRenderMgr::RenderTable n = 3<br />I/MoaiLog (16569): MoaiGooglePush onApplicationStateChanged: APPLICATION_RUNNING</div></blockquote><br /><br />Crash:<br /><blockquote class="uncited"><div>I/MoaiLog (16569): MOAIRenderMgr::RenderTable n = 1<br />I/MoaiLog (16569): MOAIRenderMgr::RenderTable n = 2<br />I/MoaiLog (16569): MOAIRenderMgr::RenderTable n = 3<br />I/MoaiLog (16569): MoaiGooglePush onApplicationStateChanged: APPLICATION_RUNNING<br />I/MoaiLog (16569): [debug]	onPurchaseStateChanged<br />I/MoaiLog (16569): MOAIRenderMgr::RenderTable n = 1<br />I/MoaiLog (16569): MOAIRenderMgr::RenderTable n = 2<br />I/MoaiLog (16569): [debug]	0:number	android.test.purchased:string	transactionId.android.test.purchased:string</div></blockquote><br /><br />Note how MoaiGooglePush.onApplicationStateChanged gets called after the OnPurchaseStateChanged handler for normal execution vs how it gets called in the middle of OnPurchaseStateChanged for the crash execution. Also note how my custom print statement indicates that MOAIRenderMgr::RenderTable is running in the middle of the crash version.<br /><br />Perhaps I'm off in the weeds here. Any other ideas?<br /><br />Thanks,<br /><br />--Paxton</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: Google in-app purchase crashing</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Tue Jun 12, 2012 6:13 pm</strong></div>
				<div class="author">by <strong>dana</strong></div>
				<div class="content">This bug should be fixed in our integration branch, which will be released soon, sometime this week.</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: Google in-app purchase crashing</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Tue Jun 12, 2012 6:22 pm</strong></div>
				<div class="author">by <strong>paxtonhare</strong></div>
				<div class="content">Thanks Dana.<br /><br /> Can you paste a link to the github commit or issue? Having been derailed by this bug for a day or two I am extremely curious to see the resolution.<br /><br />Thanks,<br /><br />--Paxton</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: Google in-app purchase crashing</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Tue Jun 12, 2012 6:26 pm</strong></div>
				<div class="author">by <strong>paxtonhare</strong></div>
				<div class="content">I think I found it. <!-- m --><a class="postlink" href="https://github.com/moai/moai-dev/commit/aafa6ec0e8031600109fccf94a08f64459496d34">https://github.com/moai/moai-dev/commit ... 4459496d34</a><!-- m --><br /><br />Thanks again.<br /><br />--Paxton</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: Google in-app purchase crashing</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Wed Jun 13, 2012 8:31 am</strong></div>
				<div class="author">by <strong>ibisum</strong></div>
				<div class="content">Oh crap, the good ol' sAkuLock fix .. yeah, Android is going to be a lot more stable in the next release with this fix in place..</div>
			</div>
			<hr />
		
	</div>

	<div id="page-footer">
		<div class="page-number">All times are UTC <br />Page <strong>1</strong> of <strong>1</strong></div>
		<div class="copyright">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</div>
	</div>
</div>

</body>
</html>