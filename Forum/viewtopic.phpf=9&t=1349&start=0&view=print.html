<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />
<meta name="robots" content="noindex" />

<title>Moai Forum &bull; View topic - FMOD out of date/broken/incomplete?</title>

<link href="styles/proFormell/theme/print.css" rel="stylesheet" type="text/css" />
<link type="image/vnd.microsoft.icon" rel="shortcut icon" href="styles/proFormell/theme/images/favicon.ico">
</head>

<body id="phpbb">
<div id="wrap">
	<a id="top" name="top" accesskey="t"></a>

	<div id="page-header">
		<h1>Moai Forum</h1>
		<p>The mobile platform for pro game developers<br /><a href="index.html">/forums/</a></p>

		<h2>FMOD out of date/broken/incomplete?</h2>
		<p><a href="fmod-out-of-date-broken-incomplete-t1349/index.html">/forums/fmod-out-of-date-broken-incomplete-t1349/</a></p>
	</div>

	<div id="page-body">
		<div class="page-number">Page <strong>1</strong> of <strong>1</strong></div>
		
			<div class="post">
				<h3>FMOD out of date/broken/incomplete?</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Thu Nov 01, 2012 8:39 am</strong></div>
				<div class="author">by <strong>stun</strong></div>
				<div class="content">Is anybody using FMODEx for sound? As I'm experimenting with MOAI non-commercially I'm interested in using FMOD as it seems a fair bit richer than the UNTZ system. However I notice the FMODEx support in the Github code is out of date. Some minor editing gets moai-fmod-ex built and running, but there's still issues.<br /><br />In particular the way MOAIFmodExChannel uses FMOD_CHANNEL_FREE when it calls the FMOD playSound function seems problematic. Are people re-using MOAIFmodExChannel instances? Or simply creating one each time they want to play a sound - which seems like a poor solution. Without doing this it seems that FMOD encounters some issue after several sounds are played in my game, because sound playback simply ceases (with no errors, crashes etc).<br /><br />Alternately are people simply writing their own FMOD bindings for MOAI? This doesn't seem that much work so I suspect that may be the case. It would seem trivial to modify MOAIFmodExChannel so each instance uses a fixed FMOD virtual channel...</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: FMOD out of date/broken/incomplete?</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Thu Nov 01, 2012 4:51 pm</strong></div>
				<div class="author">by <strong>todd</strong></div>
				<div class="content">Hi Stun - there are several developers using FMOD but usually with their own glue code. We are looking at how we can integrate that code back into the main branch of Moai at a future point for all FMOD users.</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: FMOD out of date/broken/incomplete?</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Thu Nov 01, 2012 6:10 pm</strong></div>
				<div class="author">by <strong>stun</strong></div>
				<div class="content">Hi Todd, thanks for your reply. Yes I suspected that was the case. I'll just modify the existing FMODEx wrapper so it does what I want then. Seems like a good exercise to experiment with the MOAI C++ objects.</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: FMOD out of date/broken/incomplete?</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Tue Nov 06, 2012 8:02 am</strong></div>
				<div class="author">by <strong>stun</strong></div>
				<div class="content">Ah fixed the problem I believe. There were two issues: <br /><br />1) Under Windows, or perhaps the freely downloaded version of FMOD I'm using it seems that no more than 32 'virtual channels' are supported. MOAI 1.3 initialised FMOD with 100. Once you use more than 32 channels, FMOD continues without error but simply won't play sounds on any channel other than 0-31.<br /><br />2) The MOAIFmodExChannel class holds a smart pointer to the MOAIFmodExSound it is currently playing. Unfortunately when a new sound is played on this channel, the smart pointer causes the underlying FMOD sound handle to be released underneath the MOAIFmodExSound instance. This is what mysteriously causes particular sounds to stop playing when a channel is re-used in Lua.<br /><br />I have a Github fork which fixes these issues and adds the ability to set the MOAIFmodExChannel to a specific FMOD channel which can be re-used, here: <!-- m --><a class="postlink" href="https://github.com/c0d3monk33/moai-dev/commit/ce810d444a6ff18373d226ca5bfa1c17f1d1dc0d">https://github.com/c0d3monk33/moai-dev/ ... 17f1d1dc0d</a><!-- m --><br /><br />Using these changes and installing the FMOD api under 3rdParty/fmod/api means I can happily play up to 32 channels in MOAI 1.3 without issue.</div>
			</div>
			<hr />
		
			<div class="post">
				<h3>Re: FMOD out of date/broken/incomplete?</h3>
				<div class="date"><img src="styles/proFormell/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />Posted: <strong>Tue Nov 13, 2012 8:01 am</strong></div>
				<div class="author">by <strong>stun</strong></div>
				<div class="content">Found something else interesting in the default FMOD code that ships with the SDK. Internally MOAIFmodExChannel.cpp does comparisons against the FMOD::Channel* mChannel member variable it has. This looks like a pointer to an internal FMOD 'Channel' class or structure right? So things like this seem perfectly reasonable:<br /><br /><dl class="codebox"><dt>Code: <a href="viewtopic.php%3Ff=9&amp;t=1349&amp;start=0&amp;view=print.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code style="line-height: 30%;"><ol class="cpp" style="font-family:monospace;"><li style="line-height: 50%;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span> <span style="color: #000040;">!</span>this<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>mChannel <span style="color: #008000;">&#41;</span> <span style="color: #0000ff;">return</span><span style="color: #008080;">;</span></div></li><br /></ol></code></dd></dl><br /><br />Which MOAIFmodExChannel.cpp uses several times to check if the FMOD channel is 'valid' for playing sounds on.<br /><br />Turns out no, it's not. In the FMOD C++ wrapper FMOD::Channel* is a 'magic number' that just corresponds to some FMOD bitfield. I assume the FMOD code overloads the '-&gt;' operator so that this-&gt;mChannel-&gt;function works normally. That's fine, the real problem is that FMOD channel zero (the first virtual channel) has a 'magic number' of 0x00000000 which has the unfortunate side effect of making this-&gt;mChannel look like a null pointer, when in fact it is not. It is a perfectly valid FMOD 'magic number' reference to virtual channel zero.<br /><br />Just leaving this here for anybody else that's wondering why MOAIFmodExChannel wouldn't play sounds on FMOD virtual channel zero.</div>
			</div>
			<hr />
		
	</div>

	<div id="page-footer">
		<div class="page-number">All times are UTC <br />Page <strong>1</strong> of <strong>1</strong></div>
		<div class="copyright">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</div>
	</div>
</div>

</body>
</html>